<h1>検定試験 第 <%= @kente_number.number %> 回 成績編集</h1>

<%= form_with url: admin_kente_path(@kente_number), method: :patch, class: "container" do %>
  <div class="mb-3 row align-items-center">
    <label for="kente_rank_select" class="col-sm-2 col-form-label">級位</label>
    <div class="col-sm-4">
      <%= select_tag :kente_rank_id, options_from_collection_for_select(@kente_ranks, :id, :rank), prompt: "級位を選択してください", class: "form-select", id: "kente_rank_select" %>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-light">
        <tr>
          <th scope="col" style="min-width: 150px;">生徒名</th>
          <th scope="col" style="width: 120px;">受験級</th>
          <th scope="col" style="width: 120px;">かけ算</th>
          <th scope="col" style="width: 120px;">わり算</th>
          <th scope="col" style="width: 120px;">みとり算</th>
          <th scope="col" style="width: 140px;">合計</th>
          <th scope="col" style="width: 100px;">合否</th>
        </tr>
      </thead>

      <tbody>
        <% @students.each do |student| %>
          <% kente = student.kentes.find_by(kente_number: @kente_number) %>
          <% examRank = @kente_ranks.find_by(id: kente.kente_rank_id) %>
          <tr data-kente-rank-id="<%= kente.kente_rank_id %>">
            <th class="text-start" scope="row"><%= "#{student.last_name} #{student.first_name}" %></th>
            <td><%= examRank.rank %></td>

            <%= fields_for "students[#{student.id}][kentes][#{kente.id}]", kente do |kente_form| %>
              <td><%= kente_form.number_field :multiplication_score, class: "form-control form-control-sm", required: true %></td>
              <td><%= kente_form.number_field :division_score, class: "form-control form-control-sm", required: true %></td>
              <td><%= kente_form.number_field :mitori_score, class: "form-control form-control-sm", required: true %></td>

              <td><span data-total-score><%= kente.total_score %></span></td>
              <td><span data-pass-fail="<%= examRank.passing_score %>"><%= kente.total_score >= examRank.passing_score ? "合格" : "不合格" %></span></td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="d-grid gap-2 col-6 mx-auto mt-3">
    <%= submit_tag "成績を更新", class: "btn btn-primary btn-lg" %>
  </div>
<% end %>
