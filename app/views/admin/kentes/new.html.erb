<h2>検定試験新規成績入力</h2>

<%= form_with url: admin_kentes_path, method: :post, class: "container" do %>
  <div class="mb-3 row align-items-center">
    <label for="kente_number" class="col-sm-1 col-form-label">実施回</label>
    <div class="col-sm-10 col-md-3">
      <%= number_field_tag :kente_number, nil, class: "form-control", id: "kente_number", required: true %>
    </div>

    <label for="kente_rank_select" class="col-sm-1 col-form-label">級位</label>
    <div class="col-sm-3">
      <%= select_tag :select_rank, options_from_collection_for_select(@kente_ranks, :id, :rank), prompt: "級位を選択してください", class: "form-select", id: "kente_rank_select" %>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle text-center">
      <thead class="table-light">
        <tr>
          <th scope="col" style="min-width: 130px;">生徒名</th>
          <th scope="col" style="width: 100px;">受験級</th>
          <th scope="col" style="width: 120px;">かけ算</th>
          <th scope="col" style="width: 120px;">わり算</th>
          <th scope="col" style="width: 120px;">みとり算</th>
          <th scope="col" style="width: 140px;">合計</th>
          <th scope="col" style="width: 100px;">合否</th>
        </tr>
      </thead>
      <tbody>
        <% @students.each do |student| %>
          <% kente = student.kentes.build %>
          <% kente.multiplication_score = nil %>
          <% kente.division_score = nil %>
          <% kente.mitori_score = nil %>
          <% examRank = @kente_ranks.find_by(id: student.next_kente_rank_id) %>
          <% if examRank === nil %>
            <% next %>
          <% end %>
          <tr data-next-kente-rank-id="<%= student.next_kente_rank_id %>"
            data-existed-kente-numbers="<%= student.kentes.joins(:kente_number).pluck('kente_numbers.number').join(',') %>"
          >
            <th class="text-start" scope="row"><%= "#{student.last_name} #{student.first_name}" %></th>
            <%= fields_for "students[#{student.id}]", student do |student_form| %>
              <%= student_form.hidden_field :kente_rank_id, value: student.next_kente_rank_id %>
              <%= fields_for "students[#{student.id}][kentes][]", kente do |kente_form| %>
                <td><%= examRank.rank %></td>
                <td>
                  <%= kente_form.number_field :multiplication_score, class: "form-control form-control-sm", required: true %>
                </td>
                <td>
                  <%= kente_form.number_field :division_score, class: "form-control form-control-sm", required: true %>
                </td>
                <td>
                  <%= kente_form.number_field :mitori_score, class: "form-control form-control-sm", required: true %>
                </td>
                <td><span data-total-score></span></td>
                <td><span data-pass-fail="<%= examRank.passing_score %>"></span></td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="d-grid gap-2 col-6 mx-auto mt-3">
    <%= submit_tag "成績を登録", class: "btn btn-primary btn-lg" %>
  </div>
<% end %>

